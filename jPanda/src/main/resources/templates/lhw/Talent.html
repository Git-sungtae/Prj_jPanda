<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<style type="text/css">

/* 페이지 전체 레이아웃 */
body {
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
}

/* 공통 스타일 */
ul, li {
  list-style: none;
  margin: 0;
  padding: 0;
}

/* 헤더 */
header {
  background-color: #333;
  color: #fff;
  padding: 20px;
}

/* 메뉴 */
nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 10px 0;
}

nav ul {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
}

nav li {
  margin: 0 10px;
}

nav a {
  color: #fff;
}

/* 검색 */
.search {
  display: flex;
  justify-content: center;
  align-items: center;
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
}

/* 게시글 목록 */
li {
  border: 1px solid #ccc;
  margin: 20px 10px;
  margin-bottom: 10px;
  padding: 10px;
  text-align: center;
  flex-basis: 48%;
}

li:hover {
  background-color: #f2f2f2;
}


.container {
  display: flex;
  flex-direction: column;
  align-items: center;
}

#top-title {
  text-align: center;
  margin-top: 20px;
}

#main-image {
  margin-left: 5px;
  float: left;
}

.side-info {
  margin-right: 5px;
  float: right;
  text-align: center;
}

.content {
  text-align: center;
  margin-top: 20px;
}



.review-form {
  background-color: #f2f2f2;
  border: 1px solid #ccc;
  padding: 10px;
  margin-bottom: 20px;
  max-width: 500px;
  margin-left: auto;
  margin-right: auto;
}

.review-form .form-group {
  margin-bottom: 10px;
}

.review-form h3 {
  display: inline-block;
  width: 200px;
  font-weight: bold;
  margin-right: 10px;
  text-align: center;
}

.review-form input[type="text"],
.review-form select,
.review-form textarea {
  border: 1px solid #ccc;
  padding: 5px;
  width: calc(100% - 110px);
  box-sizing: border-box;
}

.review-form select {
  width: 110px;
}

.review-form textarea {
  height: 150px;
}

.review-form input[type="submit"] {
  background-color: #4CAF50;
  color: white;
  border: none;
  padding: 10px;
  cursor: pointer;
  font-size: 16px;
}

.review-form input[type="submit"]:hover {
  background-color: #45a049;
}

.review-form input[type="submit"]:focus {
  outline: none;
}


.review-list {
  max-width: 600px;
  margin: 0 auto;
  padding: 20px;
  border: 1px solid #ccc;
  border-radius: 5px;
  list-style: none;
}


.review-list li {
  padding: 10px 0;
  border-bottom: 1px solid #ccc;
}

.review-list li:last-child {
  border-bottom: none;
}

.review-list li p {
  margin: 0;
  font-size: 14px;
}

#load-more-button {
  display: block;
  margin: 20px auto 0;
  padding: 10px 20px;
  border: none;
  border-radius: 5px;
  background-color: #007bff;
  color: #fff;
  font-size: 16px;
  cursor: pointer;
}

#load-more-button:hover {
  background-color: #0069d9;
}




</style>
<script src="/js/jquery.js"></script>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>

<header>
        <div id="logo">로고</div>
        
        <div class="search">
        	<input type="text" placeholder="검색어를 입력하세요">
            <button>검색</button>
        </div>
            
        <nav>
            <ul>
                <li><a href="#">판매 등록</a></li>
                <li><a href="#">판매 게시판</a></li>
                <li><a href="#">거래 관리</a></li>
                <li><a href="#">충전 및 내역</a></li>
                <li><a href="#">문의</a></li>
                <li><a href="#">마이 페이지</a></li>
            </ul>
        </nav>
</header>

		<!-- 판매 정보  -->
	<div class="container">
		<h1 id="top-title" th:text="${talent.title}"></h1>
		<img id="main-image" src="https://via.placeholder.com/400x300.png" alt="상품 이미지">
		
		<div class="side-info">
			  강사 : 		<div th:text="${talent.sellerId}"></div>
			  요약 설명 : 	<div th:text="${talent.summary}"></div>
			  정상 가격 : 	<div th:text="${talent.bamboo}"></div>
			  판매 가격 : 	<div th:text="${talent.saleBamboo}"></div>
		         평균 별점 :	<div id="review-filter"></div>
		         
		 	<div id="buy-btn">
			    <button>구매하기</button>
 			</div>
		</div>
		 
		<div class="etc-btn">
			<input type="hidden" id="login-id" value="${memberId}">
			<button th:if="${talent.sellerId == memberId}" id="modify-btn" th:data-talentNo="${talent.talentNo}">게시물 수정</button>
			<button th:if="${talent.sellerId == memberId}" id="delete-btn" th:data-talentNo="${talent.talentNo}" onclick="updateTalentStatus()">게시물 삭제</button>
			<button id="report-btn">게시물 신고하기</button>
		</div>
		
		<div class="quick-move">
			<a href="#review-list">리뷰</a>|<a href="#content">상세 내용</a>|<a href="">상담 및 채팅</a>
		</div>
		
		<div class="content">
			<a name="content"></a>
				상세 내용 : <div th:text="${talent.content}"></div>
		</div>
	</div>
	
	<!-- 리뷰 작성 폼  -->
	<form class="review-form" id="insert-review-form" method="post">
	    <h3 class="insert-bambooScore">리뷰를 남겨주세요</h3><br>
	    <select id="insert-bambooScore" name="bambooScore">
	        <option value="5.0">5점</option>
	        <option value="4.5">4.5점</option>
	        <option value="4.0">4점</option>
	        <option value="3.5">3.5점</option>
	        <option value="3.0">3점</option>
	        <option value="2.5">2.5점</option>
	        <option value="2.0">2점</option>
	        <option value="1.5">1.5점</option>
	        <option value="1.0">1점</option>
	    </select><br>
	    
	    <div>
	    	리뷰 내용 : <input id="insert-content" name="content"></input>
	    </div>
	    
	 	<div id="insert-review-button">
	 		<button type="button" th:onclick="'reviewInsert(' + ${talent.talentNo} + ')'">작성 완료</button>
	 	</div>
	</form>
	
	
	<!-- 리뷰 수정 폼  -->
	<form class="review-form" id="update-review-form" method="post" style="display: none;">
	    <h3 class="update-bambooScore">리뷰를 남겨주세요</h3><br>
	    <select id="update-bambooScore" name="bambooScore">
		    <option value="5.0" selected="selected">5점</option>
		    <option value="4.5">4.5점</option>
		    <option value="4.0">4점</option>
		    <option value="3.5">3.5점</option>
		    <option value="3.0">3점</option>
		    <option value="2.5">2.5점</option>
		    <option value="2.0">2점</option>
		    <option value="1.5">1.5점</option>
		    <option value="1.0">1점</option>
	    </select><br>
	    
	    <div>
	    	리뷰 내용 : <input id="update-content" name="content"></input>
	   		<input id="review-no" value="" type="hidden">
	    </div>
	   		
	 	<div id="update-review-button">
	 		<button type="button" th:onclick="'sendUpdateReview(' + ${talent.talentNo} + ')'">수정 완료</button>
	 	</div>
	</form>
	
	
	<div class="review-list">
		<a name="review-list"></a>
		<ul id="review-list">
	 		<li th:each="review : ${reviewList}">
		 		작성자 : 	<span th:text="${review.reviewerId}"></span>
		 		작성날짜 : <span th:text="${review.reviewDate}"></span>
		 		평점 : 	<span th:text="${review.bambooScore}"></span>
		 		<img class="bamboo-imges"><br>
		 		내용 : 	<span th:text="${review.content}"></span>
		 		<div class="review-btn">
		 			<input type="hidden" id="login-id" value="${memberId}">
		 			<button th:if="${review.reviewerId == memberId}" type="button" class="modifyReview" th:data-reviewNo="${review.reviewNo}" th:data-content="${review.content}" th:data-reviewerId="${review.reviewerId}">수정</button>
					<button th:if="${review.reviewerId == memberId}" type="button" class="deleteReview" th:data-reviewNo="${review.reviewNo}" th:data-talentNo="${talent.talentNo}" th:data-reviewerId="${review.reviewerId}">삭제</button>
	 			</div>
	 		</li>
		</ul>
	</div>
	
	<div>
		<button id="load-more-button">리뷰 더보기</button>
	</div>
	


<script type="text/javascript" src="/js/jquery.js"></script>	
<script>

// 게시글 수정 버튼 눌렀을때 수정 페이지로 이동
$(document).on('click', '#modify-btn', function(){
	// talentNo 값 가져오기
	var talentNo = $(this).data('talentno');
	location.href = '/talent/talents/' + talentNo + '/update-form';
});


// 게시글 삭제 버튼 눌렀을때 업데이트로 판매 상태를 판매 종료로 변경
function updateTalentStatus() {
    // talentNo 값 가져오기
    var talentNo = $("#delete-btn").data('talentno');
    if (confirm('정말로 게시물을 삭제하시겠습니까?')) {
        // 컨트롤러 이동
        location.href = '/talents/talent/updateStatus/' + talentNo;
    }
}



/*
 * TimeStamp형식으로의 현재 Date 변환
 */
function getNow(){
	const now = new Date(Date.now());
	const year = now.getFullYear();
	const month = String(now.getMonth() + 1).padStart(2, '0');
	const day = String(now.getDate()).padStart(2, '0');
	const hours = String(now.getHours()).padStart(2, '0');
	const minutes = String(now.getMinutes()).padStart(2, '0');
	const seconds = String(now.getSeconds()).padStart(2, '0');
	
	const formattedDate = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
	
	return formattedDate;
};

//리뷰 인서트 
function reviewInsert(talentNo){
	if( $("#insert-content").val().trim() == ''){
		alert('내용을 입력해주세요');
		return;
	};  
	$.ajax({
	    type : 'POST',
	    url : "/talents/talent/" + talentNo + "/reviews",
	    data : JSON.stringify({
			talentNo 	: talentNo,
			bambooScore : $("#insert-bambooScore").val(),
			content 	: $("#insert-content").val(),
			reviewDate 	: Date.now()
   		}),
	    contentType : "application/json",
	    dataType :'json',
	    success : function(review) {
	    	$('#review-list').empty();
			console.log(review);
			review.forEach(function(review){
	        	const li = $('<li>').appendTo('#review-list');
	        	$('<span>').text(review.reviewerId).appendTo(li);
	        	$('<span>').text(getNow()).appendTo(li);
	        	$('<span>').text(review.bambooScore).appendTo(li);
	        	$('<span>').text(review.content).appendTo(li);
	        	location.reload();
	        	
	        	const modifyBtn = 
	        	$('<button>').attr('type', 'button').attr('class', 'modifyReview')
	            .attr('data-reviewNo', review.reviewNo).attr('data-content', review.content).text('수정');
	        	
				const deleteBtn = 
				$('<button>').attr('type', 'button').attr('class', 'deleteReview').text('삭제');
				$('<br>').appendTo(li);
				modifyBtn.appendTo(li);
				deleteBtn.appendTo(li);
			}); 
		},
	    error : function(xhr, status, error) {
	        console.log(xhr);
	        alert('리뷰 작성에 실패하였습니다. 잠시 후 다시 시도해주세요.');
	    }
	});
}


/* /* 별점 평균에 따라  밤부 스코어 이미지 출력 
 $(function rivewImg() {
     var starImages = ['bamboo0.png', 'bamboo0.5.png', 'bamboo1.png', 'bamboo1.5.png', 'bamboo2.png', 
   	  'bamboo2.5.png', 'bamboo3.png', 'bamboo3.5.png', 'bamboo4.png', 'bamboo4.5.png', 'bamboo5.png'];
     $('.review-bamboo-score').each(function(){
     	
         var score = parseFloat($(this).text());
         console.log("score : " + score);
         if (score > 5) score = 5; // score가 5보다 크면 5로 고정
         var index;
         if (score == 0) {
           index = 0;
         } else if (score == 0.5) {
           index = 1;
         } else if (score == 1) {
           index = 2;
         } else if (score == 1.5) {
           index = 3;
         } else if (score == 2) {
           index = 4;
         } else if (score == 2.5) {
           index = 5;
         } else if (score == 3) {
           index = 6;
         } else if (score == 3.5) {
           index = 7;
         } else if (score == 4) {
           index = 8;
         } else if (score == 4.5) {
           index = 9;
         } else { // score가 5일 때
           index = 10;
         }
        console.log("index : " + index)
         $(this).next('.bamboo-imges').attr('src', '/image/bambooScore/' + starImages[index]);
    });
 }); */





$(document).on('click', '.modifyReview', function(){
	// 기존에 있는 인서트 폼 숨기고 업데이트 폼 보여주기
	$('#insert-review-form').hide();
	$('#update-review-form').show();
	// 기존 리뷰의 내용을 가져와서 업데이트 폼에 채워주기
   	$('#update-content').val($(this).data('content'));
   	$('#review-no').val($(this).data('reviewno'));
   	console.log($(this).data('content'));
   	console.log($(this).data('reviewno'));
});


// 리뷰 인서트 
function reviewInsert(talentNo){
	if( $("#insert-content").val().trim() == ''){
		alert('내용을 입력해주세요');
		return;
	};  
	$.ajax({
	    type : 'POST',
	    url : "/talents/talent/" + talentNo + "/reviews",
	    data : JSON.stringify({
			talentNo 	: talentNo,
			bambooScore : $("#insert-bambooScore").val(),
			content 	: $("#insert-content").val(),
			reviewDate 	: Date.now()
   		}),
	    contentType : "application/json",
	    dataType :'json',
	    success : function(review) {
	    	$('#review-list').empty();
			console.log(review);
			review.forEach(function(review){
	        	const li = $('<li>').appendTo('#review-list');
	        	$('<span>').text(review.reviewerId).appendTo(li);
	        	$('<span>').text(getNow()).appendTo(li);
	        	$('<span>').text(review.bambooScore).appendTo(li);
	        	$('<span>').text(review.content).appendTo(li);
	        	location.reload();
	        	
	        	const modifyBtn = 
	        	$('<button>').attr('type', 'button').attr('class', 'modifyReview')
	            .attr('data-reviewNo', review.reviewNo).attr('data-content', review.content).text('수정');
	        	
				const deleteBtn = 
				$('<button>').attr('type', 'button').attr('class', 'deleteReview').text('삭제');
				$('<br>').appendTo(li);
				modifyBtn.appendTo(li);
				deleteBtn.appendTo(li);
			}); 
		},
	    error : function(xhr, status, error) {
	        console.log(xhr);
	        alert('리뷰 작성에 실패하였습니다. 잠시 후 다시 시도해주세요.');
	    }
	});
}


// 리뷰 업데이트
function sendUpdateReview(talentNo){
	if( $("#update-content").val().trim() == ''){
		alert('내용을 입력해주세요');
		return;
};  
	var reviewNo = $("#review-no").val();
	console.log(reviewNo);
  	$.ajax({
  		type : 'PUT',
  		url : talentNo + "/reviews/" + reviewNo,
		data : JSON.stringify({
			talentNo 	: talentNo,
		    reviewNo 	: reviewNo,
		    bambooScore	: $("#update-bambooScore").val(),
		    content		: $("#update-content").val(),
		    reviewDate 	: Date.now()
 		 }),
  		    contentType : "application/json",
  			dataType : 'json',
  			success : function(review){
				$('#review-list').empty();
				console.log(review);
				review.forEach(function(review){
					const li = $('<li>').appendTo('#review-list');
		        	$('<span>').text(review.reviewerId).appendTo(li);
		        	$('<span>').text(getNow()).appendTo(li);
		        	$('<span>').text(review.bambooScore).appendTo(li);
		        	$('<span>').text(review.content).appendTo(li);
		        	location.reload();
		        	
		        	const modifyBtn = 
		        	$('<button>').attr('type', 'button').attr('class', 'modifyReview')
	                .attr('data-reviewNo', review.reviewNo).attr('data-content', review.content)
	                .text('수정');
		        	
					const deleteBtn = 
					$('<button>').attr('type', 'button').attr('class', 'deleteReview').text('삭제');
					$('<br>').appendTo(li);
					modifyBtn.appendTo(li);
					deleteBtn.appendTo(li);
				}); 
  			},
			error : function(xhr, status, error) {
		        console.log(xhr);
		        alert('리뷰 수정에 실패하였습니다. 잠시 후 다시 시도해주세요.');
		    }
  	});
}
  

// 리뷰 삭제
$(document).on('click', '.deleteReview', function() {
	var reviewNo = $(this).data("reviewno");
	var talentNo = $(this).data("talentno");
	console.log(reviewNo);
	console.log(talentNo);
  	if (confirm('리뷰를 삭제하시겠습니까?')) {
	    $.ajax({
			type : 'DELETE',
			url : talentNo + "/reviews/" + reviewNo,
			data : JSON.stringify({
				reviewNo : reviewNo,
				talentNo : talentNo
			}),
			contentType : "application/json",
			dataType : 'json',
			success : function(reviews) {
				$('#review-list').empty();
				reviews.forEach(function(review){
					const li = $('<li>').appendTo('#review-list');
		        	$('<span>').text(review.reviewerId).appendTo(li);
		        	$('<span>').text(getNow()).appendTo(li);
		        	$('<span>').text(review.bambooScore).appendTo(li);
		        	$('<span>').text(review.content).appendTo(li);
			        location.reload();
			        
		        	const modifyBtn = 
		        	$('<button>').attr('type', 'button').attr('class', 'modifyReview')
	              	.attr('data-reviewNo', review.reviewNo).attr('data-content', review.content)
	              	.text('수정');
		        	
					const deleteBtn = 
					$('<button>').attr('type', 'button').attr('class', 'deleteReview')
					.attr('data-reviewNo', review.reviewNo).text('삭제');
					
					$('<br>').appendTo(li);
					modifyBtn.appendTo(li);
					deleteBtn.appendTo(li);
				}); 
	      },
	      error : function(xhr, status, error) {
			console.log(xhr);
			alert('리뷰 삭제에 실패하였습니다. 잠시 후 다시 시도해주세요.');
	      }
		});
	}
});




</script>
	
	
<!-- 평균 리뷰 스코어와 리뷰 총 개수 출력  -->
<script th:inline="javascript">
	// 서버에서 reviewList 데이터 받기
	var reviewList = /*[[${reviewList}]]*/[];
	var reviewCount = reviewList.length;
	var totalBambooScore = 0;
	reviewList.forEach(function(review){
		totalBambooScore += review.bambooScore;
	});
	// // 반올림해서 0.5 단위로 계산
	var avgBambooScore = Math.round((totalBambooScore / reviewCount) * 2) / 2;
	// 5점 이상일 경우 5점으로 표시
	if (avgBambooScore > 5) {
		avgBambooScore = 5;
	}
	$('#review-filter').text(avgBambooScore.toFixed(1) + ' / (' + reviewCount + ')');
	
	
window.onload = function() {
	console.log([[${memberId}]]);
	};

</script>
</body>
</html>