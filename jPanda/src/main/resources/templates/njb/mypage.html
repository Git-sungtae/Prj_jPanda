

<!-- 
	로그인이 안되어 있을시에 로그인이 필요하다는 메세지만 나오고
	로그인시 회원정보나
	로그아웃시 로그인페이지로 이동
	(아직 모든거 안나옴,	수정기능 ,탈퇴기능 아직 안됨)
	


 -->

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/common/layout/default-layout">

<!-- 페이지 제목 입력 -->
<th:block layout:fragment="title">
	<title>마이페이지</title>
</th:block>

<!-- 현재 화면에서만 사용하는 css -->
<th:block layout:fragment="css">

<style type="text/css">
/*     div {
        width: 100%;
        height: 100vh;
        
        border: 1px solid rgb(248, 248, 248);
    } */
    div.left {
        width: 30%;
        float: left;
        box-sizing: border-box;
       	font-size: 30px;
        
        background: rgb(196, 196, 191);
    }
    div.right {
        width: 70%;
        float: right;
        box-sizing: border-box;
        font-size: 20px;
        
        background: rgb(250, 252, 252);
    }

.left,right{
    text-align: center;
    width: 460px;
    margin: auto;
}

/* ahref 밑줄없애기 */
a {
    text-decoration: none;
    color:black;
    
}
.left {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.withdrawal-btn-wrap {
  margin-top: auto;
  margin-bottom: 10px;
}

	</style>
	<!-- 채팅 기능이 필요없는 페이지는 아래 한줄 지워주세요  -->
	<th:block th:replace="/common/style/chat-css :: chatCssFragment"></th:block>
</th:block>

<div>
	<th:block layout:fragment="content">
   <h1 align="center">마이페이지</h1>
        <div class="left" align="center">
	        <img src="/image/basic.png" alt="기본사진">
	           <ul>   
	              <li>내프로필</li>
	              <a href="/trade" onclick="redirectToTrade()">거래내역</a>
	           </ul>
			<span class="withdrawal-btn-wrap" th:if="${session.memberId != null}">
			  <button type="button" id="withdrawal-btn" data-bs-toggle="modal" data-bs-target="#withdrawalModal">회원탈퇴</button>
			</span>	
        </div>
        
        <div class="right" align="center" th:if="${session.memberId != null}">
		    <h1>내프로필</h1>
		    <h1 th:text="'Welcome, ' + ${session.memberId} + '님!'"></h1>
				<form method="post" action="/updateMember">
				<input type="hidden" name="memberId" th:value="${memberInfo.memberId}">
				    <ul>
				        <li>
				            <span>이름: </span>
				            <input type="text" th:value="${memberInfo.name}" name="name">
				        </li>
				        <li>
				            <span>이메일: </span>
				            <input type="text" th:value="${memberInfo.email}" name="email">
				        </li>
				        <li>
				            <span>전화번호: </span>
				            <input type="text" th:value="${memberInfo.tel}" name="tel">
				        </li>
				        <li>
				            <span>성별: </span>
				            <input type="text" th:value="${memberInfo.gender}" name="gender" readonly>
				        </li>
				        <li>
				            <span>회원등급: </span>
				            <input type="text" th:value="${memberInfo.memberGrade}" name="memberGrade" readonly>
				        </li>
				        
				    </ul>
    				<button type="submit" onclick="showSuccessAlertAndRefresh()" >수정하기</button>
				</form>
			<div class="menu">
				<span>
					<a href="/" target="_blank">계정설정</a>
				</span>
				<span>
					<a href="/trade" onclick="redirectToTrade()" >거래내역</a>
				</span>
			</div>
		</div>
		<div class="right" align="center" th:unless="${session.memberId != null}">
    		<h1>로그인이 필요합니다.</h1>
		</div>
		<div class="modal fade" id="withdrawalModal" tabindex="-1" aria-labelledby="myModalLabel" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered">
		    <div class="modal-content">
		      <div class="modal-body">
		        <h5 class="modal-title mb-3" id="myModalLabel">회원탈퇴</h5>
		        <form id="withdrawal-form">
		          <div class="form-group mb-3">
		            <label for="password" class="form-label">비밀번호</label>
		            <input type="password" class="form-control" id="password" name="password" required>
			        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">취소</button>
			        <button type="button" class="btn btn-danger btn-sm" id="withdrawal-confirm-btn">탈퇴</button>
			      </div>
		        </form>
		      </div>
		    </div>
		  </div>
		</div>

		<!-- 채팅 기능이 필요없는 페이지는 아래 한줄 지워주세요  -->
		<th:block th:replace="/common/fragment/chat :: chatFragment"></th:block>
	</th:block>
</div>

<!-- 현재 화면에서만 사용하는 js -->
<th:block layout:fragment="script">
	<script th:inline="javascript">
	// 로그아웃 버튼 클릭 이벤트 핸들러 등록

	$('#logout-btn').click(function() {
	  $.ajax({
	    url: '/logout', // 로그아웃 요청을 보낼 URL
	    type: 'GET', // HTTP 요청 메서드
	    dataType: 'text', // 서버 응답 데이터 타입
	    success: function(result) {
	      alert('로그아웃 되었습니다.');
	      location.href='/login';
	    },
	    error: function(xhr, status, error) {
	      alert('로그아웃 실패: ' + error);
	    }
	  });
	});
	$('#withdrawal-confirm-btn').click(function() {
		  var password = $('#password').val();
		  if (!password) {
		    alert("비밀번호를 입력해주세요.");
		    return;
		  }
		  $.ajax({
		    url: '/withdrawal',
		    type: 'post',
		    data: { password: password },
		    success: function(response) {
		      $("#withdrawalModal").modal("hide");
		      alert(response);
		      window.location.href = "/login"; // 로그인 페이지로 이동
		    },
		    error: function(xhr, status, error) {
		      alert("회원탈퇴에 실패하였습니다. 비밀번호를 확인해주세요.");
		    }
		  });
		});

	$('#login-btn').click(function() {
		  $.ajax({
		    url: '/login',
		    type: 'GET',
		    success: function(response) {
				location.href='/login';
		    },
		    error: function(jqXHR, textStatus, errorThrown) {
		      console.log('Error: ' + errorThrown);
		    }
		  });
		});
	function showSuccessAlertAndRefresh() {
        alert("수정되었습니다.");
        location.reload(); // 페이지 새로고침
    }
	   function redirectToTrade() {
	        window.location.href = "/trade"; // 페이지 이동
	    }
	
	</script> 
		<!-- 채팅 기능이 필요없는 페이지는 아래 한줄 지워주세요  -->
	<th:block th:replace="/common/script/chat-js :: chatJsFragment"></th:block>
</th:block>
</html>