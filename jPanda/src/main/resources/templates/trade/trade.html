<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
<style type="text/css" >
	body {
		margin: 0;
		padding: 0;
		font-family: Arial, sans-serif;
	}
	
	.container {
		max-width: 80%;
		margin: 0 auto;
		padding: 20px;
	}
	
	.content{
		width : 100%;
		display: flex;
		gap : 5%;
		justify-content: space-between;
		align-items: baseline;
	}
	
	.filter-buttons {
		width : 80%;
		margin-bottom: 20px;
	}
	
	.filter-buttons button {
		background-color: #333;
		color: white;
		margin-right : 10px;
		border: none;
		padding: 10px 20px;
		border-radius: 5px;
		cursor: pointer;
		line-height: 1;
	}
	
	.filter-buttons button:hover {
		background-color: gray;
	}
	
	.filter-buttons button:active {
		background-color: #555;
		color: #fff;
		position: relative;
		top: 1px;
	}
	
	nav {
		background-color: #333;
		color: #fff;
		border-radius: 10px;
		padding: 10px;
		margin-bottom: 5%;
	}
	
	.nav-links {
		display: flex;
		justify-content: space-between;
		list-style: none;
		margin: 0;
		padding: 0;
	}
	
	.nav-links li {
		padding: 10px;
	}
	
	.nav-links a {
		color: #fff;
		text-decoration: none;
		font-weight: bold;
	}
	
	.nav-links a:hover {
		text-decoration: underline;
	}
	
	.page-title {
		margin : 0 auto;
		width : 80%;
		font-size: 22px;
		font-weight: bold;
		text-transform: uppercase;
		color: #fff;
		background-color: #333;
		padding: 20px;
		border-radius: 10px;
		box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
		text-align: center;
		margin-bottom: 5%;
	}
	
	#list-print{
		width: 80%; 
	}
	
	.trade-list{
		flex : 5;
		border: 1px solid;
		margin-bottom: 2px;
		background-color: #8FBC8F;
	}
	
	.sidebar{
		flex : 1;
		background-color: #000;
    	color: #fff;
    	border-radius: 20px;
    	padding: 10px;
    	box-sizing: border-box;
    	font-family: sans-serif;
	}

</style>
</head>
<body>
	<!-- container -->
	<div class="container">
		<!-- nav bar -->
		<nav>
		  <ul class="nav-links">
		    <li><a href="#">재능판매</a></li>
		    <li><a href="#">재능구매</a></li>
		    <li><a href="#">거래관리</a></li>
		    <li><a href="#">충전/내역</a></li>
		    <li><a href="#">마이페이지</a></li>
		  </ul>
		</nav> <!-- /nav bar -->
		
			<!-- title bar -->
			<div class="page-title">
				거래관리
			</div><!-- /title bar -->
			
			<!-- filter-buttons -->
			<div class="filter-buttons">
				<button class="filter-button" value="all">전체</button>
				<button class="filter-button" value="sell">판매</button>
				<button class="filter-button" value="buy">구매</button>
				<button class="filter-button" value="refund">환불</button>
			</div> <!-- /filter-buttons -->
			
		<!-- content -->
		<div class = "content">			
			<!-- list print -->
			<div id="list-print">
			</div> <!-- /list print -->
		
		
			<!-- sidebar -->
			<div class="sidebar">
				
				★ 판매 ★<br>
				검토중 : <span id="sidebar-submit-count"> 건</span><br>
				판매중 : <span id="sidebar-sell-count"> 건</span><br> 
				판매완료 : <span id="sidebar-sold-count"> 건</span><br>
				★ 구매 ★<br>
				구매완료 : <span id="sidebar-buy-count"> 건</span><br>
				★ 환불 ★<br>
				환불신청 : <span id="sidebar-refund-submit-count"> 건</span><br>
				환불완료 : <span id="sidebar-refund-approve-count"> 건</span><br>
				환불반려 : <span id="sidebar-refund-reject-count"> 건</span><br>
			</div> <!-- /sidebar -->
		</div> <!-- /content -->
	</div><!-- container -->
<script type="text/javascript" src="/js/jquery.js" ></script>
<script th:inline="javascript">
/**
 * statList 가공
 */
 $(function(){
	 let statList = [[${statList}]];
	 $.each(statList, function(index, stat){
		 console.log(stat);
		 switch(stat.statType){
		 	case 'sell' : 
		 		$('#sidebar-submit-count').prepend(stat.submitCount);
		 		$('#sidebar-sell-count').prepend(stat.sellCount);
		 		$('#sidebar-sold-count').prepend(stat.soldCount);
		 	break;
		 	
		 	case 'buy' : 
		 		$('#sidebar-buy-count').prepend(stat.buyCount);
		 	break;
		 	
		 	case 'refund' : 
		 		$('#sidebar-refund-submit-count').prepend(stat.refundSubmitCount);
		 		$('#sidebar-refund-approve-count').prepend(stat.refundApproveCount);
		 		$('#sidebar-refund-reject-count').prepend(stat.refundRejectCount);
		 	break;
		 }
		 
	 })
	 
 });
</script>
<script type="text/javascript">

/**
 * trade페이지 로드 완료시
 * 전체 버튼 클릭
 */
$(function() {
	$(".filter-button[value='all']").click();
});

/**
 * 판매종료 버튼 Ajax 통신 function
 */
$(document).on("click", ".end-sell-btn", function(){
	let talentNo = $(this).attr('id');
	console.log('talentNo : ' + talentNo);
	$.ajax(
		{
			type : "PUT",
			url : "/trade/talent/status/"+ talentNo,
			contentType: 'application/json',
			dataType : 'text',
			success : function(result){
				if(result === 'success'){
					confirm("판매를 종료하시겠습니까?");
					alert("판매가 종료되었습니다.");
					$(".filter-button[value='sell']").click();
				}
			},
			error : function(){
				alert("end-sell-btn function() error");
			},
		}		
	);	 
});

/**
 * 환전하기 버튼 Ajax 통신 function
 */
$(document).on("click", ".exchange-btn", function(){
	let $this = $(this);
	let talentNo = $this.attr('id');
	console.log('talentNo : ' + talentNo);
	$.ajax(
		{
			type : "POST",
			url : "/trade/exchange/"+ talentNo,
			contentType: 'application/json',
			dataType : 'text',
			success : function(message){
				console.log(message);
				alert("환전 신청이 완료되었습니다.");
				$(".filter-button[value='sell']").click();	
			},
			error : function(){
				alert("exchange-btn function() error");
			},
		}		
	);	 
});

/**
 * 환불취소 버튼 Ajax 통신 function
 */
$(document).on("click", ".refund-cancle-btn", function(){
	let purchaseNo = $(this).attr('id');
	console.log('purchaseNo : ' + purchaseNo);
	$.ajax(
		{
			type : "PUT",
			url : "/trade/refund/status/"+ purchaseNo,
			contentType: 'application/json',
			dataType : 'text',
			success : function(message){
				console.log(message);
				alert("환불이 취소되었습니다.");
				$(".filter-button[value='refund']").click();
			},
			error : function(){
				alert("refund-cancle-btn function() error");
			},
		}		
	);	 
});

/**
 * list-print tradeList Ajax 통신
 */
function getSellList(item){
	console.log(item.exchangeStatus);
	let text =  '<div style = "margin-bottom : 3%;" class = "card text-center">' + 
					'<div class = "card-header">' + item.status + '</div>' + 
					'<div class = "card-body">' +  
					'<div class = "card-title">' + item.title + '</div><br>' +
					'<div style = "color : yellowgreen;" class = "card-text">' + item.saleBamboo + '밤부</div>' +
					'<div class = "card-text">' + item.sellCount + '명이 재능을 구매했어요</div>';
				
	if(item.status === '게시중' && item.exchangeStatus === null){
		text += '<div class = "card-text">' + 
				'<button class="end-sell-btn btn btn-success" id="' + item.talentNo + '">판매종료</button></div>';
	} else if(item.status === '판매종료' && item.exchangeStatus === null){
		text += '<div class = "card-text">' + 
				'<button style = "float : right; margin-right : 1%;" class="exchange-btn btn btn-dark" id="' + item.talentNo + '">환전하기</button>' + 
				'<button style = "float : right; margin-right : 1%;" class="repost-btn btn btn-dark" id="' + item.talentNo + '">재등록</button></div>';
	} else if(item.exchangeStatus != null){
		text += '<div class = "card-text">' + 
				'환전신청이 완료된 물품입니다.</div>';
	} else {
		text += '';
	}
	
	text += '</div><div class = "card-footer text-muted">' + item.regDate + '</div></div>';
			
	$('#list-print').append(text);
}

function getBuyList(item){
	let text = '<div style = "margin-bottom : 3%;" class = "card text-center">' +  
					'<div class = "card-header">' + item.status + '</div>' +
					'<div class = "card-body">' + 
						'<div class = "card-title">' + item.title + '</div><br>' +
						'<div style = "color : yellowgreen;" class = "card-text">' + item.saleBamboo + '밤부</div>';
				
	if(item.refundableDate > 7){
		text += '<div class = "card-text">재능 구매가 확정되었어요</div>';
	} else if(item.refundableDate < 7){
		text += '<div class = "card-text">환불 가능일이 ' + (7 - item.refundableDate) + '일 남았어요</div>' + 
				'<div class = "card-text"><button style = "float : right; margin-right : 1%;" class="refund-btn btn btn-dark" id="' + item.talentNo + '">환불신청</button></div>';
	} else if(item.refundableDate === 7){
		text += '<div class = "card-text">' 
				'환불가능 마지막 날입니다!</div>' + 
				'<div class = "card-text"><button style = "float : right; margin-right : 1%;" class="refund-btn btn btn-dark" id="' + item.talentNo + '">환불신청</button></div>'; 
	}else {
		text += '';	
	}
	
	text += '</div><div class = "card-footer text-muted">' + item.purchaseDate + '</div></div>';
			
	$('#list-print').append(text);		
}

function getRefundList(item){
	let text =  '<div style = "margin-bottom : 3%;" class = "card text-center">' +  
					'<div class = "card-header">' + item.refundStatus + '</div>' +
					'<div class = "card-body">' + 
						'<div class = "card-text">' + item.title + '</div>' +
						'<div style = "color : yellowgreen;" class = "card-text">' + item.saleBamboo + '밤부</div>';
			
	if(item.refundStatus === '검토중'){
		text += '<div class = "card-text"><button style = "float : right; margin-right : 1%;" class="refund-cancle-btn btn btn-dark" id="' + item.purchaseNo + '">신청취소</button> </div>' +
				'</div><div class = "card-footer text-muted">환불신청날짜 → ' + item.submitDate + '</div></div>'; 
			 
			'</div>';
	} else if(item.refundStatus === '환불완료'){
		text += '</div><div class = "card-footer text-muted">승인날짜 → ' + item.approveDate + '</div></div>';
	} else if(item.refundStatus === '반려'){
		text += '</div><div class = "card-footer text-muted">반려날짜 → ' + item.approveDate + '</div></div>';
	} else{
		text += '</div></div>';
	}
	
	$('#list-print').append(text);		
}

$('.filter-button').on("click", function(){
	let listType = this.value;
	console.log(status);
	$.ajax(
			{
				type : "post",
				url : "/trade/list",
				contentType: 'application/json',
				dataType : "Json",
				data : JSON.stringify({'listType' : listType }),
				success : function(list){
					$('#list-print').empty();
					$.each(list, function(index, item){
						if(item.listType === 'sell'){
							getSellList(item);
						}
						if(item.listType === 'refund'){
							getRefundList(item);
						}
						if(item.listType === 'buy'){
							getBuyList(item);
						}	
					});
					
				},
				error : function(){
					console.log("filter-button on click function error");
				}
			}		
	);
});
</script>
</body>
</html>