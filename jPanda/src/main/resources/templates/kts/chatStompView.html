<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Chat Popup</title>
    <style>
      /* 스크롤 버튼 스타일 */
      #scroll-to-chat {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        background-color: #4CAF50;
        color: white;
        border-radius: 50%;
        text-align: center;
        font-size: 30px;
        line-height: 60px;
        cursor: pointer;
      }
      
      /* 팝업 채팅창 스타일 */
      #chat-popup {
        display: none;
        position: fixed;
        bottom: 100px;
        right: 50px;
        width: 400px;
        height: 500px;
        background-color: white;
        border: 1px solid #ddd;
      }
      
      /* 채팅 입력창 스타일 */
      #chat-input {
        width: 100%;
        height: 60px;
        padding: 10px;
        border: none;
        border-top: 1px solid #ddd;
        box-sizing: border-box;
        resize: none;
        overflow: auto;
        position: absolute;
        bottom: 0;
        left: 0;
      }
      
      /* 채팅 상대 목록 스타일 */
      #chat-list {
        width: 30%;
        height: 100%;
        float: left;
        box-sizing: border-box;
        border-right: 1px solid #ddd;
        overflow-y: auto;
        padding: 10px;
      }
      
      /* 선택된 채팅 상대 스타일 */
      #selected-user {
        font-weight: bold;
      }
      
      /* 채팅 대화 내용 스타일 */
      #chat-content {
        width: 70%;
        height: 100%;
        float: left;
        box-sizing: border-box;
        padding: 10px;
        overflow-y: auto;
		max-height: 200px; /* 스크롤이 필요한 최대 높이 */
		overflow-y: auto; /* 스크롤을 표시하고 내용이 넘칠 경우 스크롤을 사용할 수 있게 함 */
      }
      #chat-popup {
		  position: fixed;
		  right: 10px;
		  bottom: 10px;
		  width: 60%;
		  height: 70%;
		  background-color: #f9f9f9;
		  border: 1px solid #ccc;
		  border-radius: 5px;
		  box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
		  z-index: 9999;
		  display: none;
		}
	
	#chat-header {
	  background-color: #333;
	  color: #fff;
	  font-weight:
      }
    </style>
  </head>
  <body>
  	<select id="chat-user-list" name="userId">
 	</select><button id="connect-btn">connect</button><br>
    <div id="scroll-to-chat">&#x1F4AC;</div>
    <div id="chat-popup">
      <div id="chat-list"></div>
      <div id="chat-content"></div>
      <textarea id="chat-input" placeholder="메시지를 입력하세요..."></textarea>
    </div>

<script type="text/javascript" src="/js/jquery.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.5/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
	//전역 변수 선언
	const scrollBtn = document.getElementById("scroll-to-chat"); //$('#scroll-to-chat')
	const chatPopup = document.getElementById("chat-popup");
	const partnerList = document.getElementById("chat-list");
	const chatContent = document.getElementById("chat-content");
	const chatInput = document.getElementById("chat-input");	
	const userList = document.getElementById("chat-user-list");
	let chatList = null;
	let userId = null;
	let myChatList = null;
	let selectedChat = null;
	let message = null;
	let stompClient = null;

	//WebSocket(STOMP) 연결 함수
	function connect(userId) {
	    var socket = new SockJS('/stomp/chat?' + userId);
	    stompClient = Stomp.over(socket);
	    stompClient.connect({}, function (frame) {
	        console.log('Connected: ' + frame);
	        loadChatById(userId);
	        stompClient.subscribe('/direct/' + userId, function (message) {
	        	let parsedMessage = JSON.parse(message.body);
	        	var chatMessageElem = document.createElement("div");
	    		chatMessageElem.innerText = parsedMessage.senderId + ' :' + parsedMessage.message;
	    		chatMessageElem.classList.add("from-other");
	    		chatContent.appendChild(chatMessageElem);
		   	 	chatContent.scrollTop = chatContent.scrollHeight;
	        });
	    });
	}
	
	//연결 끊기
	function disconnect() {
	    if (stompClient !== null) {
	        stompClient.disconnect();
	    }
	    console.log("Disconnected");
	}

	
	//연결 버튼 클릭 시 연결 함수 호출
	$('#connect-btn').click(function (){
	    if($('#connect-btn').text() === 'connect'){
	    	userId = $("#chat-user-list option:selected").val();
	        connect(userId);
	        $('#connect-btn').text('disconnect');
	    } else if($('#connect-btn').text() === 'disconnect'){
	        disconnect();
	        $('#connect-btn').text('connect');
	    }
	});



	//채팅 버튼 클릭 시 채팅 팝업 띄우기
	$('#scroll-to-chat').click(function () {
	    $('#chat-popup').toggle();
   	 	chatContent.scrollTop = chatContent.scrollHeight;
	});

	// 선택된 채팅 상대 표시 업데이트
	function updateSelectedChat(element) {    
		$('#selected-user').removeAttr('id');
		$(element).attr('id', 'selected-user');
	}

	//채팅 대화 내용 업데이트
	function updateChatContent() {
		$.ajax({
			url: "/chats?userId=" + userId ,
			method: "GET",
			dataType : "json",
			success: function(chatList) {
				myChatList = chatList;
	
				var chatContentElem = document.getElementById("chat-content");
				chatContentElem.innerHTML = "";
				
				for (var i = 0; i < myChatList.length; i++) {
					
					if (myChatList[i].receiverId == selectedChat) {
						
						var chatMessageElem = document.createElement("div");
						chatMessageElem.innerText = "me :"  + myChatList[i].message;
				    	chatMessageElem.classList.add("from-me");
						chatContentElem.appendChild(chatMessageElem);
						
					} else if(myChatList[i].senderId == selectedChat){
						
						var chatMessageElem = document.createElement("div");
						chatMessageElem.innerText = myChatList[i].senderId + ":"  + myChatList[i].message;
				    	chatMessageElem.classList.add("from-other");
						chatContentElem.appendChild(chatMessageElem);
						
					}
					
				}

		   	 	chatContent.scrollTop = chatContent.scrollHeight;
			},
			error: function(jqXHR, textStatus, errorThrown) {
				console.log('getChatInfo Load Failed');
			}
		});
	}


	// 채팅창 열기/닫기
	scrollBtn.addEventListener("click", function() {
		chatPopup.style.display = "block";
	});

	chatPopup.addEventListener("click", function(e) {
		if (e.target == chatPopup) {
			chatPopup.style.display = "none";
		}
	});

	//Enter 키로 메시지 전송
	chatInput.addEventListener("keydown", function(e) {
	    if (e.keyCode == 13 && selectedChat && chatInput.value.trim() != "") {
	    	
	    	message = JSON.stringify({
	   	            'receiverId': selectedChat,
	   	            'senderId' : userId,
	   	            'message' : $('#chat-input').val(),
	   	            'chatDate' : Date.now()
	   	        })
	    	
	    	saveMessage(message);
	    	
	    	
			var chatMessageElem = document.createElement("div");
			chatMessageElem.innerText = 'me :' + chatInput.value;
			chatMessageElem.classList.add("from-me");
			chatContent.appendChild(chatMessageElem);
			chatInput.value = "";
	    }
	});
	
	//message를 DB에 저장하는 함수
	function saveMessage(message){
		$.ajax({
			url: "/chat" ,
			method: "POST",
			data : message,
			contentType : "application/json",
			dataType : "json",
			success: function(result) {
		   	    stompClient.send("/direct/" + selectedChat, {}, message);
		   	 	chatContent.scrollTop = chatContent.scrollHeight;
				return result;
			},
			error: function(jqXHR, textStatus, errorThrown) {
				console.log('saveMessage Failed');
			}
		});
	}

	//채팅 상대 리스트 업데이트
	function updateChatPartnerList(userId, chatList) {
		const chatPartnerList = new Set();
		
		for(let i = 0; i < chatList.length; i++){
			if (chatList[i].receiverId) {
				chatPartnerList.add(chatList[i].receiverId);
			}
			if (chatList[i].senderId) {
				chatPartnerList.add(chatList[i].senderId);
			}
		}
		  
		chatPartnerList.delete(userId);
	
		chatPartnerList.forEach((value, index, set) => {
			let chatPartnerElem = document.createElement("div"); //$("<div>")
			chatPartnerElem.innerText = value;  //chatPartnerElem.text(value);
			chatPartnerElem.addEventListener("click", function() { //$(document).on('click', '.chatPartnerElem', function() {
				selectedChat = this.innerText; // selectedChat = $(this).text();
				updateSelectedChat(chatPartnerElem);
				updateChatContent();
			});
			partnerList.appendChild(chatPartnerElem);  //$(partnerList).append(chatPartnerElem);
		});
	}


	//접속한 유저의 채팅내역 불러오는 함수
	function loadChatById(userId) {
		$.ajax({
			url: "/chats?userId=" + userId ,
			method: "GET",
			dataType : "json",
			success: function(chatList) {
				myChatList = chatList;
				console.log(myChatList);
				updateChatPartnerList(userId, myChatList)		
				selectedChat= partnerList.childNodes[0].textContent;
				updateSelectedChat(partnerList.childNodes[0]);
				updateChatContent();
	
			},
			error: function(jqXHR, textStatus, errorThrown) {
				console.log('chatList Load Failed');
			}
		});
	}





	//채팅 유저리스트 불러오기
	function loadChatList(chatList) {
		const chatPartnerList = new Set();
		
		for(let i = 0; i < chatList.length; i++){
			if (chatList[i].receiverId) {
				chatPartnerList.add(chatList[i].receiverId);
			}
			if (chatList[i].senderId) {
				chatPartnerList.add(chatList[i].senderId);
			}
		}
		  
	
		chatPartnerList.forEach((value, index, set) => {
			let chatPartnerElem = document.createElement("option"); 
			chatPartnerElem.value = value; 
			chatPartnerElem.innerText = value; 
			userList.appendChild(chatPartnerElem);
		});
	}

	//문서 로드 시 초기 채팅유저 리스트 불러오기
	$(document).ready(function() {
		$.ajax({
			url: "/chats?userId=",
			method: "GET",
			dataType : "json",
			success: function(receivedchatList) {
				chatList = receivedchatList;
				loadChatList(chatList);
			},
			error: function(jqXHR, textStatus, errorThrown) {
				console.log('chatList Load Failed');
			}
		});
	});
</script>
</body>
</html>
        