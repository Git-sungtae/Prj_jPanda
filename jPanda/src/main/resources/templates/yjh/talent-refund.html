<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="/common/layout/default-layout">

<!-- 페이지 제목 입력 -->
<th:block layout:fragment="title">
	<title>페이지 제목</title>
</th:block>

<!-- 현재 화면에서만 사용하는 css -->
<th:block layout:fragment="css">
	<style>
css
 
영역
</style>
	<!-- 채팅 기능이 필요없는 페이지는 아래 한줄 지워주세요  -->
	<th:block th:replace="/common/style/chat-css :: chatCssFragment"></th:block>
</th:block>

<div>
	<th:block layout:fragment="content">
		<body>
			<h1>환불 관리</h1>
			<table border="1">
				<tr>
					<th>번호</th>
					<th>신청 아이디</th>
					<th>구매번호</th>
					<th>재능번호</th>
					<th>환불 밤부</th>
					<th>환불 사유</th>
					<th>상태</th>
					<th>신청일</th>
					<th></th>
				</tr>
				<tr th:each="refund : ${refundList}">
					<td><input type="checkbox" class="checkbox"
						th:name="purchaseNo" th:value="${refund.purchaseNo}"></td>
					<td th:text="${refund.buyerId}"><input type="hidden"
						name="buyerId" th:value="${refund.buyerId}"></td>
					<td th:text="${refund.purchaseNo}"><input type="hidden"
						th:name="purchaseNo" th:value="${refund.purchaseNo}"></td>
					<td th:text="${refund.talentNo}"><input type="hidden"
						th:name="talentNo" th:value="${refund.talentNo}"></td>
					<td th:text="${refund.refundBamboo}"><input type="hidden"
						th:name="refundBamboo" th:value="${refund.refundBamboo}"></td>
					<td th:text="${refund.issue}"><input type="hidden"
						th:name="issue" th:value="${refund.issue}"></td>
					<td th:text="${refund.refundStatus}"><input type="hidden"
						th:name="status" th:value="${refund.refundStatus}"></td>
					<td th:text="${refund.approveDate}"><input type="hidden"
						th:name="approveDate" th:value="${refund.approveDate}"></td>
				</tr>
				<tr>
					<td colspan="8"><input type="button" class="btn"
						th:name="refundStatus" value="환불완료"> <input type="button"
						class="btn" th:name="refundStatus" value="반려"></td>
				</tr>
			</table>
		</body>
		<!-- 채팅 기능이 필요없는 페이지는 아래 한줄 지워주세요  -->
		<th:block th:replace="/common/fragment/chat :: chatFragment"></th:block>
	</th:block>
</div>

<!-- 현재 화면에서만 사용하는 js -->
<th:block layout:fragment="script">
	<script th:inline="javascript">
	let webSocket = new WebSocket("ws://localhost:8888/trade-ws");
	$(".btn").on("click", function() {
		let purchaseNo = $("input.checkbox:checked").map(function() {
			return $(this).val();
		}).get();

		if (purchaseNo.length === 0) {
			alert("선택된 항목이 없습니다.");
			return;
		}
		
		let talentRefundDto = [];
		let statusValue = $(this).val();
		let approveDate = Date.now();
		let buyerId = [];
		
		purchaseNo.forEach(function(item) {
			let tr = $(`input.checkbox[value='${item}']`).closest("tr");
			let td = tr.children();
			buyerId.push(td.eq(1).text());
		});
		
		
		if (statusValue == "환불완료") {
		    for (var i = 0; i < purchaseNo.length; i++) {
		        talentRefundDto.push({refundStatus: statusValue, purchaseNo: purchaseNo[i], approveDate: approveDate, buyerId: buyerId[i], listType: 'refund'});
		    }
		    
		} else if (statusValue == "반려") {
		    for (var i = 0; i < purchaseNo.length; i++) {
		        talentRefundDto.push({refundStatus: statusValue, purchaseNo: purchaseNo[i], approveDate: approveDate, buyerId: buyerId[i], listType: 'refund'});
		    }
		}
		
		$.ajax({
			type : "PATCH",
			url : "/admin/talent-refunds/" + purchaseNo.join(","),
			contentType : "application/json",
			data : JSON.stringify(talentRefundDto),
			success : function(result) {
				if(result > 0) {
					webSocket.send(JSON.stringify(talentRefundDto));
					alert("성공적으로 수정되었습니다");
					location.href="/admin/talent-refund";
					
				} else {
					alert("수정 중 오류가 발생했습니다");
					history.back();
				}
				
			},
			error : function(jqXHR, textStatus, errorThrown) {
				alert("처리 중 오류가 발생했습니다.");
			}
		});
	}); 
	</script>

	<!-- 채팅 기능이 필요없는 페이지는 아래 한줄 지워주세요  -->
	<th:block th:replace="/common/script/chat-js :: chatJsFragment"></th:block>
</th:block>
</html>