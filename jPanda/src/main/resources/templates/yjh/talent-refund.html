<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script src="/js/jquery.js"></script>
<link th:href="@{/css/board.css}" rel="stylesheet"/>
</head>
<body>
	<h1>환불 관리</h1>
		<table border="1">
			<tr>
				<th>번호</th>
				<th>신청 아이디</th>
				<th>구매번호</th>
				<th>재능번호</th>
				<th>환불 밤부</th>
				<th>환불 사유</th>
				<th>상태</th>
				<th>신청일</th>
				<th></th>
			</tr>
        	<tr th:each="refund : ${refundList}">
            	<td><input type="checkbox" class="checkbox" th:name="purchaseNo" th:value="${refund.purchaseNo}"></td>
           	 	<td th:text="${refund.buyerId}"><input type="hidden" th:name="buyerId" th:value="${refund.buyerId}"></td>
            	<td th:text="${refund.purchaseNo}"><input type="hidden" th:name="purchaseNo" th:value="${refund.purchaseNo}"></td>
            	<td th:text="${refund.talentNo}"><input type="hidden" th:name="talentNo" th:value="${refund.talentNo}"></td>
            	<td th:text="${refund.refundBamboo}"><input type="hidden" th:name="refundBamboo" th:value="${refund.refundBamboo}"></td>
            	<td th:text="${refund.issue}"><input type="hidden" th:name="issue" th:value="${refund.issue}"></td>
            	<td th:text="${refund.status}"><input type="hidden" th:name="status" th:value="${refund.status}"></td>
            	<td th:text="${refund.approveDate}"><input type="hidden" th:name="approveDate" th:value="${refund.approveDate}"></td>
       		</tr>
			<tr>
				<td colspan="8">
					<input type="button" class="submit" th:name="status" value="환불완료">
					<input type="button" class="submit" th:name="status" value="반려">
				</td>
			</tr>
		</table>
</body>
<script type="text/javascript">	 
	$(".submit").on("click", function() {
		const purchaseNo = $("input.checkbox:checked").map(function() {
			return $(this).val();
		}).get();

		if (purchaseNo.length === 0) {
			alert("선택된 항목이 없습니다.");
			return;
		}
		
		var talentRefundDto = [];
		var statusValue = $(this).val();
		
		if (statusValue == "환불완료") {
		    for (var i = 0; i < purchaseNo.length; i++) {
		        talentRefundDto.push({status: statusValue, purchaseNo: purchaseNo[i]});
		    }
		} else if (statusValue == "반려") {
		    for (var i = 0; i < purchaseNo.length; i++) {
		        talentRefundDto.push({status: statusValue, purchaseNo: purchaseNo[i]});
		    }
		}
		
		$.ajax({
			type : "PATCH",
			url : "/admin/talent-refunds/" + purchaseNo.join(","),
			contentType : "application/json",
			data : JSON.stringify(talentRefundDto),
			success : function(data) {
				// 성공했을 때 처리하는 코드
				alert("처리되었습니다.");
				location.href="/admin";
			},
			error : function(jqXHR, textStatus, errorThrown) {
				// 실패했을 때 처리하는 코드
				alert("처리 중 오류가 발생했습니다.");
			}
		});
	});
	
/* 	$(".submitToSuccess").on("click", function() {
		const purchaseNo = $("input.checkbox:checked").map(function() {
			return $(this).val();
		}).get();

		if (purchaseNo.length === 0) {
			alert("선택된 항목이 없습니다.");
			return;
		}

		const talentRefundDtoList = [];

		purchaseNo.forEach(function(item) {
			const tr = $(`input.checkbox[value='${item}']`).closest("tr");
			const td = tr.children();

			talentRefundDtoList.push({
				buyerId : td.eq(1).text(),
				purchaseNo : td.eq(2).text(),
				talentNo : td.eq(3).text(),
				refundBamboo : td.eq(4).text(),
				issue : td.eq(5).text(),
				status : td.eq(6).text(),
				approveDate : td.eq(7).text()
			});
		});

		$.ajax({
			type : "PATCH",
			url : "/admin/talent-refunds/" + purchaseNo.join(","),
			contentType : "application/json",
			data : JSON.stringify(talentRefundDtoList),
			success : function(data) {
				// 성공했을 때 처리하는 코드
				alert("처리되었습니다.");
			},
			error : function(jqXHR, textStatus, errorThrown) {
				// 실패했을 때 처리하는 코드
				alert("처리 중 오류가 발생했습니다.");
			}
		});
	}); */
</script>
</html>