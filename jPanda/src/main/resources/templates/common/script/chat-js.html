<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<div th:fragment="chatJsFragment">
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.5/sockjs.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
	<script th:inline = 'javascript'>
	
		//전역 변수 선언	
		const memberId = [[${#session.getAttribute('memberId')}]];
		let selectedChat = null;
		let stompClient = null;
		let blinkInterval = null;
	
		//WebSocket(STOMP) 연결 함수
		function connect(memberId) {
		    var socket = new SockJS('/stomp/chat?' + memberId);
		    stompClient = Stomp.over(socket);
		    stompClient.connect({}, function (frame) {
		        console.log('Connected: ' + frame);
		        loadChatByMemberId(memberId);
		        subscribe(memberId);
		    });
		}
		
		//Direct Message 를 받을 STOMP Url 구독
		function subscribe(memberId){
			stompClient.subscribe('/direct/' + memberId, function (response) {
				let messageInfo = JSON.parse(response.body);
				if (selectedChat == messageInfo.senderId){
			    	const lastDate = $('#chat-content a.chat-date').last().text();
			    	if(getDate(Date.now()) != lastDate){
						const chatDate = $("<a>").addClass("chat-date btn btn-secondary disabled").text(getDate(messageInfo.chatDate)).attr("role","button").attr("aria-disabled","true");
						$("#chat-content").append(chatDate);
			    	}
					const chatElem = $("<div>").addClass("from-other");
					const messageElem = $("<span>").text(messageInfo.message).addClass("chat-message lh-base text-start badge text-bg-success p-2 text-wrap");
					const timeElem = $("<span>").text(getTime(messageInfo.chatDate)).addClass("chat-time badge rounded-pill text-bg-light");
					chatElem.append(messageElem);
					chatElem.append(timeElem);
                    $("#chat-content").append(chatElem);
				    $("#chat-content").scrollTop($("#chat-content").prop("scrollHeight"));
				}
			    
			    if($("#chat-console").css("display") == 'none'){
			    	$("#chat-btn-alert").css("animation", "blink 1s infinite");
			    	$("#chat-btn-alert").removeClass('visually-hidden');
			    }
			});
		}
		
		//연결 끊기
		function disconnect() {
		    if (stompClient !== null) {
		        stompClient.disconnect();
		        stompClient = null;
		    }
		    console.log("Disconnected");
		}
	
		//채팅 버튼 클릭 시 채팅 팝업 띄우기
		$('#chat-btn').click(function () {
			if (stompClient !== null) { //연결 된 상태에서만 채팅 콘솔 작동 가능
				$("#chat-btn-alert").css("animation", "");
		    	$("#chat-btn-alert").addClass('visually-hidden');
			    $('#chat-console').toggle();
			    $("#chat-content").scrollTop($("#chat-content").prop("scrollHeight"));
			}
		});
	
		//선택된 채팅 상대 표시 업데이트
		function updateSelectedChat(element) {    
			$('.list-group-item').removeClass('active');
			$(element).addClass('active');
		}
	
		//채팅 대화 내용 업데이트
		function updateChatContent() {
			$.ajax({
				url: "/chats/" + memberId + "?partner-id=" + selectedChat,
				method: "GET",
				dataType : "json",
				success: function(chatList) {
					console.log("chatList =>" + chatList);
					$("#chat-content").empty();
					
					chatList.forEach((chat, index) => {
						if (chat.receiverId == selectedChat) {
							if(index == 0){
								const chatDate = $("<a>").addClass("chat-date btn btn-secondary disabled").text(getDate(chat.chatDate)).attr("role","button").attr("aria-disabled","true");
								$("#chat-content").append(chatDate);
							} else if(getDate(chatList[index - 1].chatDate) != getDate(chatList[index].chatDate)){
								const chatDate = $("<a>").addClass("chat-date btn btn-secondary disabled").text(getDate(chat.chatDate)).attr("role","button").attr("aria-disabled","true");
								$("#chat-content").append(chatDate);
							}
							const chatElem = $("<div>").addClass("from-me");
							const messageElem = $("<span>").text(chat.message).addClass("chat-message lh-base text-end badge text-bg-success p-2 text-wrap");
							const timeElem = $("<span>").text(getTime(chat.chatDate)).addClass("chat-time badge rounded-pill text-bg-light");
							chatElem.append(timeElem);
							chatElem.append(messageElem);
		                    $("#chat-content").append(chatElem);
						} else if(chat.senderId == selectedChat){
							if(index == 0){
								const chatDate = $("<a>").addClass("chat-date btn btn-secondary disabled").text(getDate(chat.chatDate)).attr("role","button").attr("aria-disabled","true");
								$("#chat-content").append(chatDate);
							} else if(getDate(chatList[index - 1].chatDate) != getDate(chatList[index].chatDate)){
								const chatDate = $("<a>").addClass("chat-date btn btn-secondary disabled").text(getDate(chat.chatDate)).attr("role","button").attr("aria-disabled","true");
								$("#chat-content").append(chatDate);
							}
							const chatElem = $("<div>").addClass("from-other");
							const messageElem = $("<span>").text(chat.message).addClass("chat-message lh-base text-start badge text-bg-success p-2 text-wrap");
							const timeElem = $("<span>").text(getTime(chat.chatDate)).addClass("chat-time badge rounded-pill text-bg-light");
							chatElem.append(messageElem);
							chatElem.append(timeElem);
		                    $("#chat-content").append(chatElem);
						}
						
					});
	
				    $("#chat-content").scrollTop($("#chat-content").prop("scrollHeight"));
				},
				error: function(jqXHR, textStatus, errorThrown) {
					console.log('updateChatContent Failed');
				}
			});
		}
	
	
		//채팅창 열기
		$("#chat-btn").click(function() {
			$("#chat-console").css("display", "block");
		});
	
	
		//채팅창 닫기
		$(function(){
			$(document).on("click", function(event) {
				if (!$(event.target).closest("#chat-console").length &&
					!$(event.target).is("#chat-btn")) {
					$("#chat-console").hide();
				}
			});
		});
		
		//Enter 키로 메시지 전송
		$("#chat-input").keyup(function(e) {
		    if (e.keyCode == 13 && selectedChat && $("#chat-input").val().trim() != "") {
		    	
		    	message = JSON.stringify({
		   	            'receiverId': selectedChat,
		   	            'senderId' : memberId,
		   	            'message' : $('#chat-input').val(),
		   	            'chatDate' : Date.now()
		   	        });
		    	
		    	saveMessage(message);
		    	
		    	const lastDate = $('#chat-content a.chat-date').last().text();
		    	if(getDate(Date.now()) != lastDate){
					const chatDate = $("<a>").addClass("chat-date btn btn-secondary disabled").text(getDate(Date.now())).attr("role","button").attr("aria-disabled","true");
					$("#chat-content").append(chatDate);
		    	}
				const chatElem = $("<div>").addClass("from-me");
				const messageElem = $("<span>").text($("#chat-input").val()).addClass("chat-message lh-base text-end badge text-bg-success p-2 text-wrap");
				const timeElem = $("<span>").text(getTime(Date.now())).addClass("chat-time badge rounded-pill text-bg-light");
				chatElem.append(timeElem);
				chatElem.append(messageElem);
                $("#chat-content").append(chatElem);
		    	$("#chat-input").val("");
		    }
		});
		
		//message를 DB에 저장하는 함수
		function saveMessage(message){
			console.log(message);
			$.ajax({
				url: "/chat" ,
				method: "POST",
				data : message,
				contentType : "application/json",
				dataType : "json",
				success: function(result) {
					console.log("result =>" + result);
			   	    stompClient.send("/direct/" + selectedChat, {}, message);
			   	    $("#chat-content").scrollTop($("#chat-content").prop("scrollHeight"));
					return result;
				},
				error: function(jqXHR, textStatus, errorThrown) {
					console.log('saveMessage Failed');
				}
			});
		}
	
		//채팅 상대 리스트 업데이트
		function updateChatPartnerList(memberId) {
			return new Promise(function(resolve, reject) {
				$.ajax({
					url: "/chats/" + memberId + "/partners",
					method: "GET",
					dataType : "json",
					success: function(partnerList) {
						$("#chat-member-list").empty();
						console.log("partnerList =>" + partnerList);
						partnerList.forEach((partner, index) => {
							let chatPartnerElem = $("<li>");
							chatPartnerElem.text(partner.name);
							chatPartnerElem.attr('value', partner.memberId);
							chatPartnerElem.attr('class', 'list-group-item list-group-item-action list-group-item-primary d-flex justify-content-between align-items-center');
							chatPartnerElem.click(function() { 
								selectedChat = partner.memberId;
								updateSelectedChat($(this));
								updateChatContent();
							});
							let unReadChatNoElem = $('<span>');
							unReadChatNoElem.attr('class', 'badge bg-primary rounded-pill');
							unReadChatNoElem.text('1');
							
							chatPartnerElem.append(unReadChatNoElem);
							$("#chat-member-list").append(chatPartnerElem);  
						});
						resolve();
					},
					error: function(jqXHR, textStatus, errorThrown) {
						console.log('updateChatPartnerList Failed');
					}
				});
			});
		}
	
		//접속한 유저의 채팅내역 불러오는 함수
		function loadChatByMemberId(memberId) {
			updateChatPartnerList(memberId).then(function(){
				selectedChat = $("#chat-member-list").children().first().attr("value");
				updateSelectedChat($("#chat-member-list").children().first());
				updateChatContent();
			});
		}
		
		//Timestamp -> chatTime
		function getTime(chatDate){
			const date = new Date(chatDate);
			const year = date.getFullYear();
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const day = String(date.getDate()).padStart(2, '0');
			const hours = String(date.getHours()).padStart(2, '0');
			const minutes = String(date.getMinutes()).padStart(2, '0');
			const seconds = String(date.getSeconds()).padStart(2, '0');
			
			const formattedTime = `${hours}:${minutes}`;
			return formattedTime;
		}
		

		//Timestamp -> chatDate
		function getDate(chatDate){
			const date = new Date(chatDate);
			const year = date.getFullYear();
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const day = String(date.getDate()).padStart(2, '0');
			const hours = String(date.getHours()).padStart(2, '0');
			const minutes = String(date.getMinutes()).padStart(2, '0');
			const seconds = String(date.getSeconds()).padStart(2, '0');
			
			const formattedDate = `${month}월 ${day}일`;
			return formattedDate;
		}
		
		//접속
		$(function(){
			if(memberId == null){
				$('#chat-btn').hide();
			} else {
				connect(memberId);
			}
		});
		
	</script>
</div> <!-- chatJsFragment -->
</html>
        